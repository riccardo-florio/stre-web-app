<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>StreamingCommunity Web</title>
</head>
<body>
    <h1>Cerca contenuti</h1>
    <form id="searchForm">
        <input type="text" id="query" placeholder="Titolo">
        <input type="submit" value="Cerca">
    </form>
    <div id="results"></div>
    <div id="preview"></div>
    <div id="progress" style="margin-top:20px;"></div>

    <script>
    const resultsEl = document.getElementById('results');
    const previewEl = document.getElementById('preview');
    const progressEl = document.getElementById('progress');

    document.getElementById('searchForm').addEventListener('submit', function(e){
        e.preventDefault();
        const q = document.getElementById('query').value.trim();
        if(!q) return;
        fetch('/api/search?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(showResults);
    });

    function showResults(results){
        previewEl.innerHTML = '';
        resultsEl.innerHTML = '';
        Object.entries(results).forEach(([name, info]) => {
            const div = document.createElement('div');
            const a = document.createElement('a');
            const year = (info.release_date || '').split('-')[0] || '?';
            a.href = '#';
            a.textContent = `${name} (${year})`;
            a.addEventListener('click', () => loadPreview(info.url.split('/').pop()));
            div.appendChild(a);
            resultsEl.appendChild(div);
        });
    }

    function loadPreview(slug){
        fetch('/api/preview/' + slug)
            .then(r => r.json())
            .then(data => {
                previewEl.innerHTML = `<h2>${data.name}</h2><p>Tipo: ${data.type}</p>`;
                progressEl.textContent = '';
                if(data.type === 'movie'){
                    const btn = document.createElement('button');
                    btn.textContent = 'Download';
                    btn.addEventListener('click', () => startDownload(data.id));
                    previewEl.appendChild(btn);
                }else{
                    const ul = document.createElement('ul');
                    data.episodeList.forEach(ep => {
                        const li = document.createElement('li');
                        li.textContent = `S${ep.season}E${ep.episode} - ${ep.name} `;
                        const btn = document.createElement('button');
                        btn.textContent = 'Download';
                        btn.addEventListener('click', () => startDownload(data.id, ep.id));
                        li.appendChild(btn);
                        ul.appendChild(li);
                    });
                    previewEl.appendChild(ul);
                }
        });
    }

    function startDownload(id, ep){
        progressEl.textContent = '0%';
        const url = '/download/' + id + (ep ? '?e=' + ep : '');
        const es = new EventSource(url);
        es.onmessage = ev => {
            if(ev.data === 'complete'){
                progressEl.textContent = 'Completato';
                es.close();
            }else{
                progressEl.textContent = ev.data + '%';
            }
        };
    }
    </script>
</body>
</html>
